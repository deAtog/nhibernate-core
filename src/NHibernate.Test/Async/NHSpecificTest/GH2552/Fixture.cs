//------------------------------------------------------------------------------
// <auto-generated>
//     This code was generated by AsyncGenerator.
//
//     Changes to this file may cause incorrect behavior and will be lost if
//     the code is regenerated.
// </auto-generated>
//------------------------------------------------------------------------------


using System;
using System.Collections.Generic;
using System.Reflection;
using NHibernate.Cache;
using NHibernate.Stat;
using NHibernate.Test.CacheTest.Caches;
using NUnit.Framework;
using NHCfg = NHibernate.Cfg;

namespace NHibernate.Test.NHSpecificTest.GH2552
{
	using System.Threading.Tasks;
	using System.Threading;
	[TestFixture]
	public class FixtureAsync : BugTestCase
	{
		protected override string CacheConcurrencyStrategy => null;

		protected override void Configure(NHCfg.Configuration configuration)
		{
			configuration.SetProperty(NHCfg.Environment.UseSecondLevelCache, "true");
			configuration.SetProperty(NHCfg.Environment.GenerateStatistics, "true");
		}

		protected override void OnTearDown()
		{
			using (var s = OpenSession())
			using (var tx = s.BeginTransaction())
			{
				s.CreateQuery("delete from DetailsByFK").ExecuteUpdate();
				s.CreateQuery("delete from PersonByFK").ExecuteUpdate();
				s.CreateQuery("delete from DetailsByRef").ExecuteUpdate();
				s.CreateQuery("delete from PersonByRef").ExecuteUpdate();

				tx.Commit();
			}

			Sfi.Evict(typeof(PersonByFK));
			Sfi.Evict(typeof(DetailsByFK));
			Sfi.Evict(typeof(PersonByRef));
			Sfi.Evict(typeof(DetailsByRef));
		}

		private async Task OneToOneTestAsync<TPerson, TDetails>(CancellationToken cancellationToken = default(CancellationToken)) where TPerson : Person, new() where TDetails : Details, new()
		{
			List<object> ids = await (this.CreatePersonAndDetailsAsync<TPerson, TDetails>(cancellationToken));

			IStatistics statistics = Sfi.Statistics;

			// Clear the second level cache and the statistics
			await (Sfi.EvictEntityAsync(typeof(TPerson).FullName, cancellationToken));
			await (Sfi.EvictEntityAsync(typeof(TDetails).FullName, cancellationToken));
			await (Sfi.EvictQueriesAsync(cancellationToken));

			statistics.Clear();

			// Fill the empty caches with data.
			await (this.FetchPeopleByIdAsync<TPerson>(ids, cancellationToken));

			// Verify that no data was retrieved from the cache.
			Assert.AreEqual(0, statistics.SecondLevelCacheHitCount, "Second level cache hit count");

			statistics.Clear();

			await (this.FetchPeopleByIdAsync<TPerson>(ids, cancellationToken));

			Assert.AreEqual(0, statistics.SecondLevelCacheMissCount, "Second level cache miss count");
		}

		private async Task<List<object>> CreatePersonAndDetailsAsync<TPerson, TDetails>(CancellationToken cancellationToken = default(CancellationToken)) where TPerson : Person, new() where TDetails : Details, new()
		{
			List<object> ids = new List<object>();

			using (ISession s = Sfi.OpenSession())
			using (ITransaction tx = s.BeginTransaction())
			{
				for (int i = 0; i < 6; i++)
				{
					Person person = new TPerson();

					if (i % 2 == 0)
					{
						Details details = new TDetails();

						details.Data = String.Format("{0}{1}", typeof(TDetails).Name, i);

						person.Details = details;
					}

					person.Name = String.Format("{0}{1}", typeof(TPerson).Name, i);

					ids.Add(await (s.SaveAsync(person, cancellationToken)));
				}

				await (tx.CommitAsync(cancellationToken));
			}

			return ids;
		}

		public async Task<IList<TPerson>> FetchPeopleByIdAsync<TPerson>(List<object> ids, CancellationToken cancellationToken = default(CancellationToken)) where TPerson : Person
		{
			IList<TPerson> people = new List<TPerson>();

			using (ISession s = Sfi.OpenSession())
			using (ITransaction tx = s.BeginTransaction())
			{
				foreach (object id in ids)
				{
					people.Add(await (s.GetAsync<TPerson>(id, cancellationToken)));
				}

				await (tx.CommitAsync(cancellationToken));
			}

			return people;
		}

		[Test]
		public async Task OneToOneCacheByForeignKeyAsync()
		{
			await (OneToOneTestAsync<PersonByFK, DetailsByFK>());
		}

		[Test]
		public async Task OneToOneCacheByRefAsync()
		{
			await (OneToOneTestAsync<PersonByRef, DetailsByRef>());
		}
	}
}
